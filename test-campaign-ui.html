<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de synchronisation des campagnes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .campaign-item {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test de synchronisation des campagnes</h1>
        <p>Ce test v√©rifie que les campagnes sont bien synchronis√©es entre l'admin et la page d'accueil.</p>

        <div class="test-section info">
            <h3>üìã Instructions</h3>
            <ol>
                <li>D√©marrez le serveur JSON : <code>npm run db</code></li>
                <li>D√©marrez l'application : <code>npm run dev</code></li>
                <li>Ouvrez l'admin dashboard et cr√©ez/modifiez une campagne</li>
                <li>V√©rifiez que la campagne appara√Æt dans la page d'accueil</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>üîç Test de l'API</h3>
            <button onclick="testAPI()">Tester l'API des campagnes</button>
            <button onclick="clearLog()">Effacer les logs</button>
            <div id="log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>üìä Campagnes actuelles</h3>
            <button onclick="loadCampaigns()">Charger les campagnes</button>
            <div id="campaigns"></div>
        </div>

        <div class="test-section">
            <h3>üîÑ Test de synchronisation</h3>
            <button onclick="testSync()">Tester la synchronisation</button>
            <div id="syncResult"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001';
        let logElement = document.getElementById('log');
        let campaignsElement = document.getElementById('campaigns');
        let syncResultElement = document.getElementById('syncResult');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            logElement.textContent += logMessage;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            logElement.textContent = '';
        }

        async function makeRequest(path, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (data) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(`${API_BASE}${path}`, options);
                const result = await response.json();
                
                return {
                    status: response.status,
                    data: result
                };
            } catch (error) {
                throw new Error(`Erreur de requ√™te: ${error.message}`);
            }
        }

        async function testAPI() {
            log('üß™ D√©but du test de l\'API...');
            
            try {
                // Test 1: V√©rifier l'acc√®s au serveur
                log('1Ô∏è‚É£ V√©rification de l\'acc√®s au serveur...');
                const healthCheck = await makeRequest('/health');
                if (healthCheck.status !== 200) {
                    throw new Error(`Serveur non accessible: ${healthCheck.status}`);
                }
                log('‚úÖ Serveur accessible');

                // Test 2: R√©cup√©rer les campagnes
                log('2Ô∏è‚É£ R√©cup√©ration des campagnes...');
                const campaigns = await makeRequest('/campaigns');
                if (campaigns.status !== 200) {
                    throw new Error(`Erreur lors de la r√©cup√©ration: ${campaigns.status}`);
                }
                
                const campaignCount = Array.isArray(campaigns.data) ? campaigns.data.length : 0;
                log(`‚úÖ ${campaignCount} campagnes r√©cup√©r√©es`);

                // Test 3: Cr√©er une campagne de test
                log('3Ô∏è‚É£ Cr√©ation d\'une campagne de test...');
                const testCampaign = {
                    title: `Test UI - ${new Date().toLocaleTimeString()}`,
                    organizer: 'Test Interface',
                    description: 'Campagne cr√©√©e via l\'interface de test',
                    link: 'https://example.com',
                    status: 'planned'
                };

                const createResult = await makeRequest('/campaigns', 'POST', testCampaign);
                if (createResult.status !== 201) {
                    throw new Error(`Erreur lors de la cr√©ation: ${createResult.status}`);
                }
                
                log(`‚úÖ Campagne cr√©√©e avec l'ID: ${createResult.data.id}`);

                // Test 4: V√©rifier la cr√©ation
                log('4Ô∏è‚É£ V√©rification de la cr√©ation...');
                const getResult = await makeRequest(`/campaigns/${createResult.data.id}`);
                if (getResult.status !== 200) {
                    throw new Error(`Erreur lors de la r√©cup√©ration: ${getResult.status}`);
                }
                
                log(`‚úÖ Campagne r√©cup√©r√©e: ${getResult.data.title}`);

                // Test 5: Supprimer la campagne de test
                log('5Ô∏è‚É£ Suppression de la campagne de test...');
                const deleteResult = await makeRequest(`/campaigns/${createResult.data.id}`, 'DELETE');
                if (deleteResult.status !== 200) {
                    log(`‚ö†Ô∏è Erreur lors de la suppression: ${deleteResult.status}`);
                } else {
                    log('‚úÖ Campagne supprim√©e');
                }

                log('üéâ Test de l\'API termin√© avec succ√®s !');

            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        async function loadCampaigns() {
            log('üìä Chargement des campagnes...');
            
            try {
                const result = await makeRequest('/campaigns');
                if (result.status !== 200) {
                    throw new Error(`Erreur: ${result.status}`);
                }

                const campaigns = Array.isArray(result.data) ? result.data : [];
                campaignsElement.innerHTML = '';

                if (campaigns.length === 0) {
                    campaignsElement.innerHTML = '<p>Aucune campagne trouv√©e</p>';
                    return;
                }

                campaigns.forEach(campaign => {
                    const campaignDiv = document.createElement('div');
                    campaignDiv.className = 'campaign-item';
                    campaignDiv.innerHTML = `
                        <strong>${campaign.title}</strong><br>
                        <small>Organisateur: ${campaign.organizer || 'N/A'}</small><br>
                        <small>Statut: ${campaign.status}</small><br>
                        <small>ID: ${campaign.id}</small>
                    `;
                    campaignsElement.appendChild(campaignDiv);
                });

                log(`‚úÖ ${campaigns.length} campagnes charg√©es`);

            } catch (error) {
                log(`‚ùå Erreur lors du chargement: ${error.message}`, 'error');
                campaignsElement.innerHTML = '<p>Erreur lors du chargement des campagnes</p>';
            }
        }

        async function testSync() {
            log('üîÑ Test de synchronisation...');
            
            try {
                // Simuler un √©v√©nement de changement
                const event = new CustomEvent('campaigns:changed', {
                    detail: { action: 'test', timestamp: new Date().toISOString() }
                });
                
                window.dispatchEvent(event);
                log('‚úÖ √âv√©nement campaigns:changed d√©clench√©');
                
                // Attendre un peu puis recharger
                setTimeout(async () => {
                    await loadCampaigns();
                    log('‚úÖ Campagnes recharg√©es apr√®s √©v√©nement');
                }, 1000);

            } catch (error) {
                log(`‚ùå Erreur lors du test de synchronisation: ${error.message}`, 'error');
            }
        }

        // Charger les campagnes au chargement de la page
        window.addEventListener('load', () => {
            log('üöÄ Interface de test charg√©e');
            loadCampaigns();
        });
    </script>
</body>
</html>
